<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>APY Monitor — Compound v3 USDC (Base) & Morpho Seamless USDC Vault</title>
    <style>
      :root { --g1:#0a3d2d; --g2:#1dd16a; --panel:#eaffe8; --ink:#053526; --muted:#1b5e47; --chip:#10a167; }
      html, body { height: 100%; }
      body { margin:0; color:var(--ink); font:16px/1.55 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
             background: linear-gradient(135deg, var(--g1) 0%, var(--g2) 100%); }
      .wrap { max-width: 980px; margin: 0 auto; padding: 36px 18px 48px; }
      h1 { margin: 0 0 8px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,.25); }
      .lead { color: rgba(255,255,255,.92); margin-bottom: 18px; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px,1fr)); gap: 16px; }
      .card { background: var(--panel); border: 1px solid rgba(0,0,0,.06); border-radius: 16px; padding: 16px; box-shadow: 0 8px 28px rgba(0,0,0,.14); }
      .hdr { display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin-bottom:8px; }
      .ttl { font-weight: 800; font-size: 18px; }
      .badge { background: var(--chip); color: #fff; font-weight: 800; padding: 4px 8px; border-radius: 999px; font-size: 12px; }
      .row { display: flex; gap: 16px; flex-wrap: wrap; }
      .box { flex: 1; min-width: 220px; border: 1px dashed rgba(0,0,0,.12); border-radius: 12px; padding: 12px; background: #fff; }
      .label { color: var(--muted); font-weight: 700; letter-spacing:.2px; }
      .val { font-size: 32px; font-weight: 900; }
      .foot { margin-top: 12px; display:flex; align-items:center; gap:10px; flex-wrap: wrap; }
      .last { color: var(--muted); }
      .hint { color: var(--muted); font-size: 13px; margin-top: 6px; }
      button { padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(0,0,0,.08); background: #c6ffd8; cursor: pointer; font-weight: 800; }
      code { background: #ecfff1; padding: 2px 6px; border-radius: 6px; }
      .err { color:#8b0000; font-size:13px; margin-top:6px;}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  </head>
  <body>
    <div class="wrap">
      <h1>APY Monitor</h1>
      <div class="lead">Compound v3 USDC (Base) and Morpho Seamless USDC Vault — auto-refreshes every 20 minutes.</div>

      <div class="grid">
        <!-- Compound v3 USDC (Base) -->
        <section class="card">
          <div class="hdr"><div class="ttl">Compound v3 — USDC (Base)</div><span class="badge">COMET</span></div>
          <div class="row">
            <div class="box"><div class="label">Protocol Supply APR</div><div id="c_apr" class="val">—</div></div>
            <div class="box"><div class="label">Protocol Supply APY</div><div id="c_apy" class="val">—</div><div class="hint">Excludes any external rewards.</div></div>
            <div class="box"><div class="label">Utilization</div><div id="c_util" class="val">—</div></div>
          </div>
          <div class="foot"><button id="c_refresh">Refresh Compound</button><span class="last">Updated: <span id="c_updated">—</span></span></div>
          <div class="hint">RPC: <code>https://mainnet.base.org</code> • Comet: <code>0xb125E6687d4313864e53df431d5425969c15Eb2F</code></div>
        </section>

        <!-- Morpho Seamless USDC Vault (Base) -->
        <section class="card">
          <div class="hdr"><div class="ttl">Morpho Seamless USDC Vault (Base)</div><span class="badge">MORPHO</span></div>
          <div class="row">
            <div class="box"><div class="label">Vault APY (net)</div><div id="m_apy" class="val">—</div><div id="m_err" class="err"></div></div>
            <div class="box"><div class="label">Source</div><div id="m_source" class="val" style="font-size:18px;">—</div><div class="hint">Matches website via Vercel function.</div></div>
          </div>
          <div class="foot"><button id="m_refresh">Refresh Morpho</button><span class="last">Updated: <span id="m_updated">—</span></span></div>
          <div class="hint">Vault: <code id="vault">0x616a4E1db48e22028f6bbf20444Cd3b8e3273738</code></div>
        </section>
      </div>
    </div>

    <script>
      // ===== Helpers =====
      const SECONDS_PER_YEAR = 365 * 24 * 60 * 60;
      const SCALE = 1e18;
      const BASE_RPC = "https://mainnet.base.org";
      function apyFromPerSecond(ratePerSecond) { return Math.pow(1 + ratePerSecond, SECONDS_PER_YEAR) - 1; }

      // ===== Compound v3 (Base) USDC =====
      const COMET = "0xb125E6687d4313864e53df431d5425969c15Eb2F";
      const C_ABI = [
        "function getUtilization() view returns (uint256)",
        "function getSupplyRate(uint256) view returns (uint64)"
      ];
      async function loadCompound() {
        try {
          const provider = new ethers.JsonRpcProvider(BASE_RPC);
          const comet = new ethers.Contract(COMET, C_ABI, provider);
          const utilization = await comet.getUtilization();
          const perSec = await comet.getSupplyRate(utilization);
          const u = Number(utilization) / SCALE;
          const rps = Number(perSec) / SCALE;
          const apr = rps * SECONDS_PER_YEAR;
          const apy = apyFromPerSecond(rps);
          document.getElementById("c_apr").textContent = (apr * 100).toFixed(3) + "%";
          document.getElementById("c_apy").textContent = (apy * 100).toFixed(3) + "%";
          document.getElementById("c_util").textContent = (u * 100).toFixed(2) + "%";
          document.getElementById("c_updated").textContent = new Date().toLocaleString();
        } catch (e) { console.error(e); document.getElementById("c_apr").textContent = document.getElementById("c_apy").textContent = document.getElementById("c_util").textContent = "Error"; }
      }
      document.getElementById("c_refresh").addEventListener("click", loadCompound);

      // ===== Morpho via Vercel API (same origin) =====
      const MORPHO_VAULT = document.getElementById("vault").textContent.trim().toLowerCase();
      async function loadMorpho() {
        const errEl = document.getElementById("m_err");
        errEl.textContent = "";
        try {
          const res = await fetch(`/api/morpho?vault=${encodeURIComponent(MORPHO_VAULT)}`);
          const txt = await res.text();
          if (!res.ok) throw new Error(`HTTP ${res.status} ${txt}`);
          const data = JSON.parse(txt);
          let apy = null;
          if (data.netApy != null) apy = Number(data.netApy);
          else if (data.apy != null) apy = Number(data.apy);
          else if (data.currentApy != null) apy = Number(data.currentApy);
          else if (data.netApyBps != null) apy = Number(data.netApyBps) / 10000;
          else if (data.apyBps != null) apy = Number(data.apyBps) / 10000;
          if (apy == null || !isFinite(apy)) throw new Error("No APY field in payload: " + JSON.stringify(data).slice(0,400));
          document.getElementById("m_apy").textContent = (apy * 100).toFixed(3) + "%";
          document.getElementById("m_source").textContent = "Morpho API via Vercel";
          document.getElementById("m_updated").textContent = new Date().toLocaleString();
        } catch (e) {
          console.error("Morpho fetch error:", e);
          document.getElementById("m_apy").textContent = "Error";
          document.getElementById("m_source").textContent = "—";
          errEl.textContent = String(e).slice(0, 300);
        }
      }
      document.getElementById("m_refresh").addEventListener("click", loadMorpho);

      function init(){ loadCompound(); loadMorpho(); }
      init();
      setInterval(init, 20 * 60 * 1000);
    </script>
  </body>
</html>
